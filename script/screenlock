#!/bin/sh

HIBERNATE_TIMEOUT=20
HIBERNATE_CMD="loginctl hibernate"
SCREENLOCK_CMD=slock
XIDLEHOOK_PID=

start_idlehook() {
    [ -x "$(command -v xidlehook)" ] || return 0
    xidlehook --once --timer "$(echo "$HIBERNATE_TIMEOUT*60" | bc)" "$HIBERNATE_CMD" "" &
    XIDLEHOOK_PID=$!
}

stop_idlehook() {
    [ -n "$XIDLEHOOK_PID" ] || return 0
    kill "$XIDLEHOOK_PID" 2>/dev/null
}

while [ $# -gt 0 ]; do
    case $1 in
        -i|--immediate) HIBERNATE_TIMEOUT=0 ;;
    esac
    shift
done

if [ -x "$(command -v $SCREENLOCK_CMD)" ]; then
    start_idlehook
    $SCREENLOCK_CMD
    stop_idlehook
fi
